<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>PMOC QR – Ar Condicionado</title>
  <meta name="theme-color" content="#0ea5e9" />
  <meta name="description" content="App mobile (HTML5/CSS3/JS) para gestão de PMOC com QR Code: cadastrar equipamentos, gerar e ler QR, registrar visitas, exportar dados." />
  <!-- Biblioteca de leitura de QR (100% client-side) -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <!-- Lib para gerar QR (QRCode.js) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <!-- Estilos: mobile-first, leve e moderno -->
  <style>
    :root {
      --bg: #0b1220;         /* fundo escuro elegante */
      --card: #0f172a;       /* azul ardósia */
      --muted: #94a3b8;      /* texto secundário */
      --text: #e2e8f0;       /* texto claro */
      --brand: #0ea5e9;      /* ciano */
      --ok: #10b981;         /* verde */
      --warn: #f59e0b;       /* âmbar */
      --bad: #ef4444;        /* vermelho */
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      background: linear-gradient(180deg, #0b1220 0%, #111827 100%);
      color: var(--text);
    }
    .app { max-width: 820px; margin: 0 auto; padding-bottom: 96px; }
    header {
      position: sticky; top: 0; z-index: 10;
      background: rgba(11,18,32,0.8); backdrop-filter: saturate(140%) blur(10px);
      border-bottom: 1px solid rgba(148,163,184,0.15);
    }
    .topbar { display: flex; align-items: center; gap: 12px; padding: 14px 16px; }
    .brand { display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.4px; }
    .brand .logo { width: 32px; height: 32px; border-radius: 10px; background: radial-gradient(circle at 30% 20%, #38bdf8, #0ea5e9 60%, #0369a1); box-shadow: 0 6px 22px rgba(56,189,248,.35) inset, 0 2px 14px rgba(14,165,233,.25); }
    .badge { font-size: 12px; color: var(--muted); border: 1px solid rgba(148,163,184,.2); padding: 2px 8px; border-radius: 999px; }

    .toolbar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 0 16px 14px; }
    .btn {
      appearance: none; border: 1px solid rgba(148,163,184,.18); background: linear-gradient(180deg, #0f172a 0%, #0b1220 100%);
      color: var(--text); padding: 12px; border-radius: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;
      box-shadow: 0 2px 12px rgba(2,6,23,.25), inset 0 1px 0 rgba(255,255,255,.04);
    }
    .btn:active { transform: translateY(1px); }
    .btn.primary { border-color: rgba(14,165,233,.45); box-shadow: 0 6px 30px rgba(14,165,233,.25); }

    main { padding: 16px; }
    .card {
      background: linear-gradient(180deg, #0f172a 0%, #0b1220 100%);
      border: 1px solid rgba(148,163,184,.15);
      border-radius: var(--radius);
      padding: 16px; margin-bottom: 14px;
      box-shadow: 0 10px 40px rgba(2,6,23,.35);
    }
    h2 { margin: 0 0 10px; font-size: 18px; }
    .sub { color: var(--muted); font-size: 13px; margin-top: -6px; }

    form { display: grid; gap: 10px; }
    .row { display: grid; gap: 10px; }
    @media(min-width:680px){ .row { grid-template-columns: repeat(2,1fr); } }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    input, select, textarea {
      width: 100%; padding: 12px 12px; border-radius: 12px; border: 1px solid rgba(148,163,184,.2);
      background: #0b1220; color: var(--text); outline: none;
    }
    textarea { min-height: 90px; resize: vertical; }

    .list { display: grid; gap: 10px; }
    .item {
      background: #0b1220; border: 1px solid rgba(148,163,184,.18); border-radius: 14px; padding: 12px;
      display: grid; gap: 8px;
    }
    .item h4 { margin: 0; font-size: 15px; }
    .pill { font-size: 11px; color: #cffafe; background: rgba(14,165,233,.15); border: 1px solid rgba(14,165,233,.35); padding: 3px 8px; border-radius: 999px; }
    .muted { color: var(--muted); }

    .tabs { display:flex; gap:8px; flex-wrap:wrap; }
    .tab { padding: 8px 12px; border-radius: 999px; border:1px solid rgba(148,163,184,.2); color: var(--text); background: #0b1220; font-weight:600; }
    .tab.active { border-color: rgba(14,165,233,.5); box-shadow: 0 0 0 3px rgba(14,165,233,.15) inset; }

    .grid2 { display:grid; gap:14px; }
    @media(min-width:820px){ .grid2 { grid-template-columns: 1fr 1fr; } }

    .sticky-bottom {
      position: fixed; left: 0; right: 0; bottom: 0; z-index: 20;
      background: rgba(11,18,32,.9); backdrop-filter: blur(8px);
      border-top: 1px solid rgba(148,163,184,.15);
    }
    .nav { display:grid; grid-template-columns: repeat(5,1fr); }
    .nav button { appearance:none; border:none; background:transparent; color:var(--muted); padding:12px 6px; font-size:12px; }
    .nav button.active { color: var(--text); font-weight:700; }

    canvas.signature { background: #0b1220; border-radius: 12px; border:1px dashed rgba(148,163,184,.3); width:100%; height:180px; }

    .qr-box { display:grid; place-items:center; padding:12px; border:1px dashed rgba(148,163,184,.3); border-radius: 14px; }
    #qrPreview canvas, #qrPreview img { width: 220px; height: 220px; }

    .helper { font-size:12px; color:var(--muted); }
    .danger { color: var(--bad); }
    .success { color: var(--ok); }
    .center { text-align:center; }
    #qrReader { width: 100%; max-width: 560px; margin: 8px auto; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="topbar">
        <div class="logo" aria-hidden="true"></div>
        <div class="brand">
          <div>PMOC QR</div>
          <span class="badge">Ar Condicionado</span>
        </div>
        <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
          <button class="btn" id="btnBackup" title="Backup JSON">Exportar</button>
          <button class="btn" id="btnRestore" title="Restaurar JSON">Importar</button>
          <input id="restoreInput" type="file" accept="application/json" style="display:none" />
        </div>
      </div>
      <div class="toolbar">
        <button class="btn primary" data-nav="equip">Equipamentos</button>
        <button class="btn" data-nav="gerar">Gerar QR</button>
        <button class="btn" data-nav="ler">Ler QR</button>
        <button class="btn" data-nav="visitas">Visitas</button>
      </div>
    </header>

    <main>
      <!-- TABS -->
      <section id="tab-equip" class="card">
        <h2>Cadastro de Equipamento</h2>
        <div class="sub">Registre os dados do ar-condicionado. Cada equipamento recebe um ID único e pode ter várias visitas PMOC vinculadas.</div>
        <form id="equipForm">
          <div class="row">
            <div>
              <label>Código/Patrimônio *</label>
              <input required name="patrimonio" placeholder="Ex.: AC-SALA-001" />
            </div>
            <div>
              <label>Modelo/Marca</label>
              <input name="modelo" placeholder="Ex.: Split 24k BTU – LG" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Local/Setor *</label>
              <input required name="local" placeholder="Ex.: Sala Reunião 1º Andar" />
            </div>
            <div>
              <label>Capacidade (BTU)</label>
              <input name="btu" inputmode="numeric" placeholder="Ex.: 24000" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Nº Série</label>
              <input name="serie" placeholder="Ex.: SN123456" />
            </div>
            <div>
              <label>Responsável</label>
              <input name="responsavel" placeholder="Ex.: João Silva" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Observações</label>
              <textarea name="obs" placeholder="Filtros laváveis, compressor externo em laje..."></textarea>
            </div>
            <div>
              <label>Periodicidade PMOC</label>
              <select name="periodo">
                <option value="Mensal">Mensal</option>
                <option value="Bimestral">Bimestral</option>
                <option value="Trimestral">Trimestral</option>
                <option value="Semestral">Semestral</option>
                <option value="Anual">Anual</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <button type="submit" class="btn primary">Salvar equipamento</button>
            </div>
            <div>
              <button type="button" id="btnNovoEquip" class="btn">Novo</button>
            </div>
          </div>
        </form>

        <div style="margin-top:12px;" class="list" id="equipList"></div>
      </section>

      <section id="tab-gerar" class="card" hidden>
        <h2>Gerar QR Code</h2>
        <div class="sub">Selecione um equipamento e gere um QR contendo o ID e dados essenciais. Imprima e fixe próximo ao aparelho.</div>
        <div class="grid2">
          <div>
            <label>Equipamento</label>
            <select id="qrEquipSelect"></select>
            <div class="qr-box" style="margin-top:12px">
              <div id="qrPreview"></div>
            </div>
            <div class="row" style="margin-top:12px">
              <button class="btn primary" id="btnGerarQR">Gerar QR</button>
              <button class="btn" id="btnBaixarQR">Baixar PNG</button>
            </div>
            <div class="helper">O QR carrega um JSON compacto com o campo <code>id</code> do equipamento. O app reconhece automaticamente ao ler.</div>
          </div>
          <div>
            <div class="item">
              <h4>Etiqueta sugerida</h4>
              <div class="muted">Inclui Patrimônio, Local, Periodicidade, QR e link opcional.</div>
              <div id="labelPreview" class="qr-box" style="background:#fff; color:#000;"></div>
              <div class="row" style="margin-top:8px">
                <button class="btn" id="btnBaixarEtiqueta">Baixar Etiqueta (PNG)</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-ler" class="card" hidden>
        <h2>Ler QR Code</h2>
        <div class="sub">Aponte a câmera para o QR do equipamento. O app decodifica e abre o registro automaticamente.</div>
        <div class="item">
          <div class="row">
            <div>
              <label>Câmera</label>
              <select id="cameraSelect"></select>
            </div>
            <div style="display:flex; align-items:end; gap:8px;">
              <button class="btn primary" id="btnStartScan">Iniciar</button>
              <button class="btn" id="btnStopScan">Parar</button>
              <button class="btn" id="btnFlip">Trocar</button>
            </div>
          </div>
          <div id="qrReader" class="qr-box"></div>
          <div id="scanStatus" class="helper">Status: parado</div>
        </div>
        <div id="scanResult" class="card" style="margin-top:12px" hidden></div>
        <div class="helper">Dica: para o leitor de câmera funcionar no celular, abra este arquivo via <strong>HTTPS</strong> ou <strong>localhost</strong>.</div>
      </section>

      <section id="tab-visitas" class="card" hidden>
        <h2>Registro de Visita PMOC</h2>
        <div class="sub">Se preferir, leia primeiro o QR do equipamento. Também é possível selecionar manualmente abaixo.</div>
        <form id="visitaForm">
          <div class="row">
            <div>
              <label>Equipamento *</label>
              <select required id="visEquip"></select>
            </div>
            <div>
              <label>Data *</label>
              <input required type="date" id="visData" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Checklist</label>
              <div class="item" style="display:grid; gap:6px">
                <label><input type="checkbox" name="chk" value="Higienização filtros" /> Higienização filtros</label>
                <label><input type="checkbox" name="chk" value="Verificação dreno" /> Verificação dreno</label>
                <label><input type="checkbox" name="chk" value="Aperto conexões elétricas" /> Aperto conexões elétricas</label>
                <label><input type="checkbox" name="chk" value="Limpeza evaporadora/condensadora" /> Limpeza evaporadora/condensadora</label>
                <label><input type="checkbox" name="chk" value="Medição temperatura/pressão" /> Medição temperatura/pressão</label>
              </div>
            </div>
            <div>
              <label>Situação</label>
              <select id="visStatus">
                <option value="OK">OK</option>
                <option value="Atenção">Atenção</option>
                <option value="Crítico">Crítico</option>
              </select>
              <label style="margin-top:10px; display:block;">Observações</label>
              <textarea id="visObs" placeholder="Anote recomendações ou não conformidades"></textarea>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Assinatura do Técnico</label>
              <canvas class="signature" id="sigPad"></canvas>
              <div class="row" style="margin-top:8px">
                <button type="button" class="btn" id="btnLimparAss">Limpar</button>
              </div>
            </div>
            <div>
              <label>Foto (opcional)</label>
              <input type="file" id="visFoto" accept="image/*" capture="environment" />
              <div class="helper">Fotos são salvas em baixa resolução para caber no armazenamento local.</div>
            </div>
          </div>
          <div class="row">
            <button class="btn primary" type="submit">Salvar visita</button>
            <button class="btn" type="button" id="btnExportCSV">Exportar CSV</button>
          </div>
        </form>
        <div id="visList" class="list" style="margin-top:12px"></div>
      </section>
    </main>

    <div class="sticky-bottom">
      <div class="nav">
        <button data-nav="equip" class="active">Equip</button>
        <button data-nav="gerar">Gerar</button>
        <button data-nav="ler">Ler</button>
        <button data-nav="visitas">Visitas</button>
        <button id="btnInfo">Info</button>
      </div>
    </div>
  </div>

  <script>
    // ====== Utilidades de armazenamento ======
    const DB = {
      load(){
        try {
          return JSON.parse(localStorage.getItem('pmocqr-db')||'{"equip":[],"visitas":[]}');
        } catch(e){ return { equip:[], visitas:[] }; }
      },
      save(data){ localStorage.setItem('pmocqr-db', JSON.stringify(data)); },
      uid(){ return 'eq_' + Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4); }
    };
    let state = DB.load();

    // ====== Navegação ======
    const tabs = {
      equip: document.getElementById('tab-equip'),
      gerar: document.getElementById('tab-gerar'),
      ler: document.getElementById('tab-ler'),
      visitas: document.getElementById('tab-visitas')
    };
    function show(tab){
      // ao trocar de aba, garantir que o scanner pare
      if(tab !== 'ler') stopScanner();
      Object.entries(tabs).forEach(([k,el])=> el.hidden = (k!==tab));
      document.querySelectorAll('[data-nav]').forEach(btn=>btn.classList.toggle('active', btn.dataset.nav===tab));
      if(tab==='gerar') fillQrSelect();
      if(tab==='visitas') { fillVisEquip(); renderVisitas(); }
      if(tab==='equip') renderEquipList();
      if(tab==='ler') initCameras();
    }
    document.querySelectorAll('[data-nav]').forEach(btn=> btn.addEventListener('click', ()=> show(btn.dataset.nav)) );

    // ====== Equipamentos ======
    const equipForm = document.getElementById('equipForm');
    const equipList = document.getElementById('equipList');
    const btnNovoEquip = document.getElementById('btnNovoEquip');
    let editingId = null;

    function formToEquip(){
      const fd = new FormData(equipForm);
      const obj = Object.fromEntries(fd.entries());
      obj.patrimonio = obj.patrimonio?.trim();
      obj.local = obj.local?.trim();
      obj.modelo = obj.modelo?.trim();
      obj.serie = obj.serie?.trim();
      obj.responsavel = obj.responsavel?.trim();
      obj.btu = obj.btu?.trim();
      obj.obs = obj.obs?.trim();
      obj.periodo = obj.periodo || 'Mensal';
      return obj;
    }

    function clearEquipForm(){ equipForm.reset(); editingId = null; }

    function renderEquipList(){
      equipList.innerHTML = '';
      if(!state.equip.length){ equipList.innerHTML = '<div class="helper">Sem equipamentos cadastrados ainda.</div>'; return; }
      state.equip.forEach(eq=>{
        const el = document.createElement('div'); el.className = 'item';
        el.innerHTML = `
          <div style="display:flex; align-items:center; gap:8px; justify-content:space-between;">
            <div>
              <h4>${eq.patrimonio} <span class="pill">${eq.periodo}</span></h4>
              <div class="muted">${eq.local || ''} • ${eq.modelo || ''} • BTU: ${eq.btu || '-'}</div>
            </div>
            <div style="display:flex; gap:6px;">
              <button class="btn" data-act="qr" data-id="${eq.id}">QR</button>
              <button class="btn" data-act="edit" data-id="${eq.id}">Editar</button>
              <button class="btn" data-act="del" data-id="${eq.id}">Excluir</button>
            </div>
          </div>`;
        equipList.appendChild(el);
      });
      equipList.querySelectorAll('button[data-act]').forEach(b=> b.addEventListener('click', onEquipAction));
    }

    function onEquipAction(e){
      const id = e.currentTarget.dataset.id; const act = e.currentTarget.dataset.act;
      const eq = state.equip.find(x=>x.id===id);
      if(!eq) return;
      if(act==='edit'){
        editingId = id;
        for(const [k,v] of Object.entries(eq)){
          const input = equipForm.querySelector(`[name="${k}"]`);
          if(input) input.value = v || '';
        }
        show('equip');
      } else if(act==='del'){
        if(confirm('Excluir este equipamento?')){
          state.visitas = state.visitas.filter(v=>v.equipId!==id);
          state.equip = state.equip.filter(x=>x.id!==id);
          DB.save(state); renderEquipList();
        }
      } else if(act==='qr'){
        show('gerar');
        document.getElementById('qrEquipSelect').value = id;
        gerarQR();
      }
    }

    equipForm.addEventListener('submit', (ev)=>{
      ev.preventDefault();
      const data = formToEquip();
      if(!data.patrimonio || !data.local){ alert('Preencha Patrimônio e Local.'); return; }
      if(editingId){
        const idx = state.equip.findIndex(x=>x.id===editingId);
        if(idx>-1){ state.equip[idx] = { ...state.equip[idx], ...data }; }
      } else {
        const id = DB.uid();
        state.equip.push({ id, ...data, createdAt: Date.now() });
      }
      DB.save(state); clearEquipForm(); renderEquipList(); alert('Equipamento salvo!');
    });

    btnNovoEquip.addEventListener('click', ()=> clearEquipForm());

    // ====== Gerar QR ======
    const qrEquipSelect = document.getElementById('qrEquipSelect');
    const qrPreview = document.getElementById('qrPreview');
    const btnGerarQR = document.getElementById('btnGerarQR');
    const btnBaixarQR = document.getElementById('btnBaixarQR');
    const labelPreview = document.getElementById('labelPreview');
    const btnBaixarEtiqueta = document.getElementById('btnBaixarEtiqueta');

    function fillQrSelect(){
      qrEquipSelect.innerHTML = state.equip.map(eq=>`<option value="${eq.id}">${eq.patrimonio} — ${eq.local}</option>`).join('');
    }

    function gerarQR(){
      qrPreview.innerHTML = '';
      const id = qrEquipSelect.value || (state.equip[0]?.id);
      if(!id){ qrPreview.innerHTML = '<div class="helper">Cadastre um equipamento primeiro.</div>'; return; }
      const eq = state.equip.find(x=>x.id===id);
      const payload = { t:'pmoc-equip', id: id, patrimonio: eq.patrimonio, local: eq.local };
      new QRCode(qrPreview, { text: JSON.stringify(payload), width: 220, height: 220, correctLevel: QRCode.CorrectLevel.M });
      const qrEl = qrPreview.querySelector('canvas') || qrPreview.querySelector('img');
      renderEtiqueta(eq, qrEl);
    }

    function renderEtiqueta(eq, qrEl){
      // Desenhar etiqueta em canvas branco: título, infos e QR
      const W=480, H=300; const pad=16;
      const cvs = document.createElement('canvas'); cvs.width=W; cvs.height=H;
      const ctx = cvs.getContext('2d');
      // fundo
      ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,W,H);
      // cabeçalho
      ctx.fillStyle = '#0ea5e9'; ctx.fillRect(0,0,W,52);
      ctx.fillStyle = '#ffffff'; ctx.font='700 18px system-ui'; ctx.fillText('PMOC • Ar Condicionado', pad, 32);
      // texto
      ctx.fillStyle = '#000000'; ctx.font='600 18px system-ui'; ctx.fillText(eq.patrimonio, pad, 90);
      ctx.font='400 14px system-ui'; ctx.fillText('Local: ' + (eq.local||'-'), pad, 116);
      ctx.fillText('Periodicidade: ' + (eq.periodo||'-'), pad, 136);
      ctx.fillText('Modelo: ' + (eq.modelo||'-'), pad, 156);
      // QR no lado direito
      if(qrEl){
        // desenha tanto <canvas> quanto <img>
        try { ctx.drawImage(qrEl, W-220-pad, 72, 220, 220); } catch(_) {}
      }
      // rodapé
      ctx.font='12px system-ui'; ctx.fillStyle = '#111827';
      ctx.fillText('Leia o QR para abrir ficha do equipamento e registrar visita.', pad, H-16);
      labelPreview.innerHTML = ''; labelPreview.appendChild(cvs);
    }

    btnGerarQR.addEventListener('click', gerarQR);
    btnBaixarQR.addEventListener('click', ()=>{
      const el = qrPreview.querySelector('canvas') || qrPreview.querySelector('img'); if(!el){ alert('Gere o QR primeiro.'); return; }
      let dataUrl;
      if(el.tagName && el.tagName.toLowerCase()==='canvas'){
        dataUrl = el.toDataURL('image/png');
      } else {
        const c = document.createElement('canvas');
        const w = el.naturalWidth || 220, h = el.naturalHeight || 220;
        c.width=w; c.height=h; c.getContext('2d').drawImage(el,0,0,w,h);
        dataUrl = c.toDataURL('image/png');
      }
      const a = document.createElement('a'); a.download = 'qr-equipamento.png'; a.href = dataUrl; a.click();
    });
    btnBaixarEtiqueta.addEventListener('click', ()=>{
      const img = labelPreview.querySelector('canvas'); if(!img){ alert('Gere o QR primeiro.'); return; }
      const a = document.createElement('a'); a.download = 'etiqueta-pmoc.png'; a.href = img.toDataURL('image/png'); a.click();
    });

    // ====== Leitor de QR (html5-qrcode) ======
    const cameraSelect = document.getElementById('cameraSelect');
    const scanStatus = document.getElementById('scanStatus');
    const scanResult = document.getElementById('scanResult');
    const btnStartScan = document.getElementById('btnStartScan');
    const btnStopScan = document.getElementById('btnStopScan');
    const btnFlip = document.getElementById('btnFlip');

    let html5Qr = null; let cameras = []; let camIndex = 0; let scanning = false;

    async function initCameras(){
      try{
        cameras = await Html5Qrcode.getCameras();
        if(!cameras || !cameras.length){ cameraSelect.innerHTML = '<option>Sem câmera</option>'; scanStatus.textContent='Sem câmera disponível'; return; }
        // tenta priorizar a traseira
        const envIdx = cameras.findIndex(c=>/back|traseira|environment/i.test(c.label));
        camIndex = envIdx >= 0 ? envIdx : 0;
        cameraSelect.innerHTML = cameras.map((c,i)=>`<option value="${i}">${c.label||('Câmera '+(i+1))}</option>`).join('');
        cameraSelect.value = String(camIndex);
      }catch(err){
        cameraSelect.innerHTML = '<option>Permissão negada?</option>';
        scanStatus.textContent = 'Erro ao listar câmeras. Permita acesso à câmera.';
      }
    }

    async function startScanner(){
      if(scanning) return;
      if(!cameras.length){ await initCameras(); if(!cameras.length) return; }
      try {
        const cam = cameras[camIndex];
        if(!html5Qr) html5Qr = new Html5Qrcode('qrReader');
        const size = Math.min(Math.floor(window.innerWidth*0.7), 320);
        scanStatus.textContent = 'Lendo...';
        await html5Qr.start({ deviceId: { exact: cam.id } }, { fps: 12, qrbox: size }, onQRFound, onQRError);
        scanning = true;
      } catch(err){
        scanStatus.textContent = 'Não foi possível iniciar a câmera. Use HTTPS/localhost e permita acesso.';
        console.error(err);
      }
    }

    async function stopScanner(){
      if(html5Qr && scanning){
        try { await html5Qr.stop(); } catch(_){}
        try { await html5Qr.clear(); } catch(_){}
      }
      scanning = false; scanStatus.textContent = 'Status: parado';
    }

    function onQRError(msg){ /* erros frequentes de leitura — ignorar no UI */ }

    function onQRFound(decodedText){
      stopScanner();
      try{
        const obj = JSON.parse(decodedText);
        if(obj.t==='pmoc-equip' && obj.id){
          const eq = state.equip.find(x=>x.id===obj.id);
          if(eq){ openEquip(eq); return; }
        }
        // não pertence ao app
        showUnknown(decodedText);
      }catch(e){
        showUnknown(decodedText);
      }
    }

    function showUnknown(data){
      scanResult.hidden = false;
      scanResult.innerHTML = `<div class="muted">Conteúdo do QR:</div><pre style="white-space:pre-wrap">${String(data).replace(/[<>]/g,'')}</pre>`;
      scanStatus.textContent = 'QR lido (formato não reconhecido)';
    }

    function openEquip(eq){
      scanResult.hidden = false;
      scanResult.innerHTML = `
        <h3 style="margin:0 0 6px">${eq.patrimonio} <span class="pill">${eq.periodo}</span></h3>
        <div class="muted">${eq.local || ''} • ${eq.modelo || ''} • BTU: ${eq.btu || '-'}</div>
        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="goVisita">Registrar visita</button>
          <button class="btn" id="goGerar">Gerar novo QR</button>
        </div>`;
      document.getElementById('goVisita').onclick = ()=>{ show('visitas'); document.getElementById('visEquip').value = eq.id; };
      document.getElementById('goGerar').onclick = ()=>{ show('gerar'); document.getElementById('qrEquipSelect').value = eq.id; gerarQR(); };
      scanStatus.textContent = 'QR lido com sucesso';
    }

    cameraSelect.addEventListener('change', ()=>{ camIndex = parseInt(cameraSelect.value||'0',10)||0; if(scanning){ stopScanner(); startScanner(); }});
    document.getElementById('btnStartScan').addEventListener('click', startScanner);
    document.getElementById('btnStopScan').addEventListener('click', stopScanner);
    document.getElementById('btnFlip').addEventListener('click', ()=>{ if(!cameras.length) return; camIndex = (camIndex+1)%cameras.length; cameraSelect.value = String(camIndex); if(scanning){ stopScanner(); startScanner(); } });

    // ====== Visitas ======
    const visEquip = document.getElementById('visEquip');
    const visData = document.getElementById('visData');
    const visStatus = document.getElementById('visStatus');
    const visObs = document.getElementById('visObs');
    const visitaForm = document.getElementById('visitaForm');
    const visFoto = document.getElementById('visFoto');
    const visList = document.getElementById('visList');

    function fillVisEquip(){
      visEquip.innerHTML = state.equip.map(eq=>`<option value="${eq.id}">${eq.patrimonio} — ${eq.local}</option>`).join('');
    }
    function renderVisitas(){
      visList.innerHTML = '';
      const list = [...state.visitas].sort((a,b)=> b.data.localeCompare(a.data));
      if(!list.length){ visList.innerHTML = '<div class="helper">Sem visitas ainda.</div>'; return; }
      list.forEach(v=>{
        const eq = state.equip.find(x=>x.id===v.equipId);
        const el = document.createElement('div'); el.className='item';
        el.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <div>
              <h4>${eq?.patrimonio || v.equipId} • <span class="pill">${v.status}</span></h4>
              <div class="muted">${v.data} • ${eq?.local || ''}</div>
            </div>
            <div style="display:flex; gap:6px;">
              <button class="btn" data-del="${v.id}">Excluir</button>
            </div>
          </div>
          ${v.checklist?.length? `<div class="muted">Checklist: ${v.checklist.join(', ')}</div>`:''}
          ${v.obs? `<div class="muted">Obs: ${v.obs}</div>`:''}
          ${v.assinatura? `<img alt="Assinatura" style="width:100%; max-height:160px; object-fit:contain; border-radius:8px;" src="${v.assinatura}" />`:''}
          ${v.foto? `<img alt="Foto" style="width:100%; max-height:200px; object-fit:cover; border-radius:8px;" src="${v.foto}" />`:''}
        `;
        visList.appendChild(el);
      });
      visList.querySelectorAll('button[data-del]').forEach(b=> b.addEventListener('click', (ev)=>{
        const id = ev.currentTarget.dataset.del; if(confirm('Excluir esta visita?')){
          state.visitas = state.visitas.filter(x=>x.id!==id); DB.save(state); renderVisitas();
        }
      }));
    }

    // assinatura canvas simples
    const sigPad = document.getElementById('sigPad');
    const sigCtx = sigPad.getContext('2d');
    let drawing=false, last=null;
    function sigResize(){ const r = sigPad.getBoundingClientRect(); const dpr = Math.max(1, window.devicePixelRatio||1); sigPad.width = r.width * dpr; sigPad.height = r.height * dpr; sigCtx.setTransform(1,0,0,1,0,0); sigCtx.scale(dpr, dpr); sigCtx.lineWidth=2; sigCtx.strokeStyle='#e2e8f0'; }
    window.addEventListener('resize', sigResize); sigResize();
    function sigPoint(e){ const rect = sigPad.getBoundingClientRect(); const t=e.touches? e.touches[0]:e; const x=t.clientX-rect.left; const y=t.clientY-rect.top; return {x,y}; }
    function sigStart(e){ drawing=true; last=sigPoint(e); }
    function sigMove(e){ if(!drawing) return; const p=sigPoint(e); sigCtx.beginPath(); sigCtx.moveTo(last.x,last.y); sigCtx.lineTo(p.x,p.y); sigCtx.stroke(); last=p; }
    function sigEnd(){ drawing=false; }
    sigPad.addEventListener('mousedown', sigStart); sigPad.addEventListener('mousemove', sigMove); window.addEventListener('mouseup', sigEnd);
    sigPad.addEventListener('touchstart', sigStart, {passive:true}); sigPad.addEventListener('touchmove', sigMove, {passive:true}); sigPad.addEventListener('touchend', sigEnd);
    document.getElementById('btnLimparAss').addEventListener('click', ()=>{ sigCtx.clearRect(0,0,sigPad.width, sigPad.height); sigResize(); });

    visitaForm.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      if(!visEquip.value){ alert('Selecione um equipamento'); return; }
      const data = {
        id: 'v_' + Math.random().toString(36).slice(2,10),
        equipId: visEquip.value,
        data: visData.value || new Date().toISOString().slice(0,10),
        status: visStatus.value,
        obs: visObs.value.trim(),
        checklist: Array.from(visitaForm.querySelectorAll('input[name="chk"]:checked')).map(i=>i.value),
        assinatura: sigPad.toDataURL('image/png'),
        foto: null
      };
      // foto redimensionada
      if(visFoto.files && visFoto.files[0]){
        data.foto = await fileToDataURLResized(visFoto.files[0], 1024, 1024);
      }
      state.visitas.push(data); DB.save(state); visitaForm.reset(); sigCtx.clearRect(0,0,sigPad.width,sigPad.height); sigResize(); renderVisitas(); alert('Visita registrada!');
    });

    function fileToDataURLResized(file, maxW, maxH){
      return new Promise((resolve)=>{
        const fr = new FileReader(); fr.onload = ()=>{
          const img = new Image(); img.onload = ()=>{
            let w=img.width, h=img.height; const ratio = Math.min(maxW/w, maxH/h, 1);
            const c = document.createElement('canvas'); c.width=w*ratio; c.height=h*ratio; const cx=c.getContext('2d');
            cx.drawImage(img,0,0,c.width,c.height); resolve(c.toDataURL('image/jpeg', 0.75));
          }; img.src = fr.result;
        }; fr.readAsDataURL(file);
      });
    }

    // ====== Exportar/Importar ======
    document.getElementById('btnBackup').addEventListener('click', ()=>{
      const a = document.createElement('a');
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      a.href = URL.createObjectURL(blob); a.download = 'pmocqr-backup.json'; a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
    });
    document.getElementById('btnRestore').addEventListener('click', ()=> document.getElementById('restoreInput').click());
    document.getElementById('restoreInput').addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const fr = new FileReader(); fr.onload = ()=>{ try{ state = JSON.parse(fr.result); DB.save(state); alert('Backup importado!'); show('equip'); }catch(err){ alert('Arquivo inválido.'); } };
      fr.readAsText(f);
    });

    // ====== Export CSV ======
    document.getElementById('btnExportCSV').addEventListener('click', ()=>{
      if(!state.visitas.length){ alert('Sem visitas para exportar.'); return; }
      const headers = ['id','equipId','patrimonio','local','data','status','checklist','obs'];
      const rows = state.visitas.map(v=>{
        const eq = state.equip.find(x=>x.id===v.equipId) || {}; 
        return [v.id, v.equipId, eq.patrimonio||'', eq.local||'', v.data, v.status, (v.checklist||[]).join('|'), v.obs?.replace(/\n/g,' ')||''];
      });
      const csv = [headers.join(';')].concat(rows.map(r=>r.map(x=>`"${(x+"").replace(/"/g,'\\"')}"`).join(';'))).join('\n');
      const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); a.download='visitas-pmoc.csv'; a.click();
    });

    // ====== Info ======
    document.getElementById('btnInfo').addEventListener('click', ()=>{
      alert('PMOC QR — App HTML5/CSS3/JS\n\nFuncionalidades:\n• Cadastro de equipamentos\n• Geração e leitura de QR Code\n• Registro de visitas com checklist, foto e assinatura\n• Exportação CSV/JSON e importação de backup\n\nDica: Para usar como “app”, adicione à tela inicial do celular. Para o leitor funcionar, use HTTPS/localhost.');
    });

    // inicialização
    function fillAll(){ renderEquipList(); fillQrSelect(); fillVisEquip(); }
    fillAll(); show('equip');
  </script>
</body>
</html>
